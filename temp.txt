# Form implementation generated from reading ui file 'main_mindow.ui'
#
# Created by: PyQt6 UI code generator 6.4.0
#
# WARNING: Any manual changes made to this file will be lost when pyuic6 is
# run again.  Do not edit this file unless you know what you are doing.


from PyQt6 import QtCore, QtGui, QtWidgets
from PyQt6.QtGui import QCloseEvent
from drivers import NIDAQ


class ADCThread(QtCore.QThread):
    adc_data = QtCore.pyqtSignal(object)

    def __init__(self, adc_config):
        QtCore.QThread.__init__(self)
        self.adc = NIDAQ.NIDAQ(
            dev_id=adc_config['dev_id'],
            rate=adc_config['rate'],
            acq_time=adc_config['acq_time'],
            channels=adc_config['channels'],
            volt_range=adc_config['range'])
        self.n_channels = len(adc_config['channels'])
        self.quit = False

    def run(self) -> None:
        while not self.quit:
            data = self.adc.get()
            result = ';'.join(['{:0.5f}'.format(d) for d in data])
            self.adc_data.emit(result)
        self.adc.close()

    def stop(self):
        self.quit = True


class Ui_main_window(QtWidgets.QMainWindow):
    adc_stop = QtCore.pyqtSignal(object)

    def __init__(self):
        super(Ui_main_window, self).__init__()
        self.setObjectName("main_window")
        self.resize(1024, 768)
        sizePolicy = QtWidgets.QSizePolicy(QtWidgets.QSizePolicy.Policy.Fixed, QtWidgets.QSizePolicy.Policy.Fixed)
        sizePolicy.setHorizontalStretch(0)
        sizePolicy.setVerticalStretch(0)
        sizePolicy.setHeightForWidth(self.sizePolicy().hasHeightForWidth())
        self.setSizePolicy(sizePolicy)
        font = QtGui.QFont()
        font.setPointSize(14)
        self.setFont(font)
        self.centralwidget = QtWidgets.QWidget(self)
        self.centralwidget.setObjectName("centralwidget")
        self.type_box_1 = QtWidgets.QComboBox(self.centralwidget)
        self.type_box_1.setGeometry(QtCore.QRect(28, 120, 150, 40))
        sizePolicy = QtWidgets.QSizePolicy(QtWidgets.QSizePolicy.Policy.Fixed, QtWidgets.QSizePolicy.Policy.Fixed)
        sizePolicy.setHorizontalStretch(0)
        sizePolicy.setVerticalStretch(0)
        sizePolicy.setHeightForWidth(self.type_box_1.sizePolicy().hasHeightForWidth())
        self.type_box_1.setSizePolicy(sizePolicy)
        self.type_box_1.setCurrentText("")
        self.type_box_1.setMaxVisibleItems(5)
        self.type_box_1.setObjectName("type_box_1")
        self.adc1_result = QtWidgets.QLineEdit(self.centralwidget)
        self.adc1_result.setGeometry(QtCore.QRect(80, 270, 113, 20))
        self.adc1_result.setObjectName("adc1_result")
        self.adc2_result = QtWidgets.QLineEdit(self.centralwidget)
        self.adc2_result.setGeometry(QtCore.QRect(330, 360, 113, 20))
        self.adc2_result.setObjectName("adc2_result")
        self.fixButton = QtWidgets.QPushButton(self.centralwidget)
        self.fixButton.setGeometry(QtCore.QRect(460, 220, 131, 51))
        self.fixButton.setObjectName("fixButton")
        self.setCentralWidget(self.centralwidget)
        self.statusbar = QtWidgets.QStatusBar(self)
        self.statusbar.setObjectName("statusbar")
        self.setStatusBar(self.statusbar)

        self.retranslateUi(self)
        self.type_box_1.setCurrentIndex(-1)
        QtCore.QMetaObject.connectSlotsByName(self)

        self.type_box_1.addItems(['тип 1', 'тип 2', 'тип 3', 'тип 4'])
        self.fix = False
        self.fixButton.clicked.connect(self.fix_results)

        config = {
            'dev_id': 'Dev1',
            'rate': 1000,
            'acq_time': 0.2,
            'channels': (0, 1, 2, 3, 4, 5, 6, 7),
            'range': 5,
        }
        self.fix = False
        self.adc = ADCThread(adc_config=config)
        self.adc.start()
        self.adc.adc_data.connect(self.update_fields)

    def update_fields(self, data):
        adc_data = data.split(';')
        if not self.fix:
            self.adc1_result.setText(adc_data[0])
            self.adc2_result.setText(adc_data[1])

    def fix_results(self):
        self.fix = not self.fix

    def closeEvent(self, event: QCloseEvent):
        self.adc.stop()

    def retranslateUi(self, main_wind):
        _translate = QtCore.QCoreApplication.translate
        main_wind.setWindowTitle(_translate("main_window", "Тестер датчиков удара"))
        main_wind.fixButton.setText(_translate("main_window", "FIX"))


if __name__ == "__main__":
    import sys
    app = QtWidgets.QApplication(sys.argv)
    main_window = QtWidgets.QMainWindow()
    ui = Ui_main_window()
    main_window.show()
    sys.exit(app.exec())
